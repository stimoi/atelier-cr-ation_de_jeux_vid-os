<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>√âditeur de Niveaux - Isaac</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, Segoe UI, Roboto, Arial; background: linear-gradient(135deg,#667eea,#764ba2); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; border-radius: 14px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,.25); }
        .header { padding: 24px; color: #fff; background: linear-gradient(135deg,#667eea,#764ba2); text-align: center; }
        .header h1 { margin: 0 0 8px; }
        .toolbar { padding: 16px; background: #f8f9fa; border-bottom: 3px solid #667eea; }
        .tool-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .tool-btn { padding: 10px 14px; border-radius: 8px; border: 2px solid #ddd; background: #fff; cursor: pointer; }
        .tool-btn.active { background: #667eea; border-color: #667eea; color: #fff; }
        .canvas-container { background: #e9ecef; padding: 20px; }
        #gameCanvas { display: block; margin: 0 auto; background: #87CEEB; border: 3px solid #333; box-shadow: 0 5px 20px rgba(0,0,0,.2); }
        .controls { padding: 16px; background: #f8f9fa; border-top: 3px solid #667eea; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group input { padding: 8px 10px; border: 2px solid #ddd; border-radius: 6px; }
        .action-btn { padding: 12px 18px; border: 0; border-radius: 8px; color: #fff; cursor: pointer; background: linear-gradient(135deg,#667eea,#764ba2); box-shadow: 0 4px 12px rgba(102,126,234,.4); }
        .action-btn.secondary { background: linear-gradient(135deg,#f093fb,#f5576c); }
        .action-btn.neutral { background: #495057; }
        .notification { position: fixed; top: 20px; right: 20px; background: #4caf50; color: #fff; padding: 12px 18px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.25); }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéÆ √âditeur de Niveaux</h1>
        <div>Cr√©ez vos niveaux et exportez-les pour le jeu</div>
      </div>

      <div class="toolbar">
        <div class="tool-buttons">
          <button class="tool-btn active" data-tool="platform">üü´ Plateforme</button>
          <button class="tool-btn" data-tool="player">üë§ Joueur</button>
          <button class="tool-btn" data-tool="spike">‚ö†Ô∏è Pi√®ge</button>
          <button class="tool-btn" data-tool="goal">üéØ Arriv√©e</button>
          <button class="tool-btn" data-tool="erase">üóëÔ∏è Effacer</button>
        </div>
      </div>

      <div class="canvas-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
      </div>

      <div class="controls">
        <div class="control-group">
          <label for="gridSize">Taille grille:</label>
          <input id="gridSize" type="number" value="40" min="20" max="80" />
        </div>
        <div class="control-group">
          <label for="levelName">Nom du niveau:</label>
          <input id="levelName" type="text" value="niveau_1" />
        </div>
        <button class="action-btn" onclick="saveToGame()">üöÄ Enregistrer dans le jeu</button>
        <button class="action-btn secondary" onclick="clearCanvas()">üóëÔ∏è Effacer tout</button>
        <button class="action-btn neutral" onclick="exportJSON()">‚¨áÔ∏è Exporter JSON (jeu)</button>
        <button class="action-btn neutral" onclick="exportPython()">‚¨áÔ∏è Exporter Python (jeu)</button>
      </div>
    </div>

    <script>
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      let currentTool = 'platform';
      let gridSize = 40;
      let isDrawing = false;

      let levelData = {
        platforms: [],
        player: null,
        spikes: [],
        goal: null,
      };

      // Outils
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentTool = this.dataset.tool;
        });
      });

      document.getElementById('gridSize').addEventListener('change', e => {
        gridSize = parseInt(e.target.value, 10) || 40;
        redraw();
      });

      // Dessin grille
      function drawGrid() {
        ctx.strokeStyle = '#ddd';
        ctx.lineWidth = 0.5;
        for (let x = 0; x < canvas.width; x += gridSize) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); }
        for (let y = 0; y < canvas.height; y += gridSize) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }
      }

      function redraw() {
        ctx.fillStyle = '#87CEEB';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawGrid();
        // Plateformes
        ctx.fillStyle = '#8B4513';
        levelData.platforms.forEach(p => { ctx.fillRect(p.x, p.y, p.width, p.height); ctx.strokeStyle = '#654321'; ctx.lineWidth = 2; ctx.strokeRect(p.x, p.y, p.width, p.height); });
        // Joueur
        if (levelData.player) { ctx.fillStyle = '#4169E1'; ctx.fillRect(levelData.player.x, levelData.player.y, levelData.player.width, levelData.player.height); ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.strokeRect(levelData.player.x, levelData.player.y, levelData.player.width, levelData.player.height); }
        // Pi√®ges
        ctx.fillStyle = '#FF4500'; levelData.spikes.forEach(s => { ctx.fillRect(s.x, s.y, s.width, s.height); ctx.strokeStyle = '#8B0000'; ctx.lineWidth = 2; ctx.strokeRect(s.x, s.y, s.width, s.height); });
        // Arriv√©e
        if (levelData.goal) { ctx.fillStyle = '#32CD32'; ctx.fillRect(levelData.goal.x, levelData.goal.y, levelData.goal.width, levelData.goal.height); ctx.strokeStyle = '#228B22'; ctx.lineWidth = 2; ctx.strokeRect(levelData.goal.x, levelData.goal.y, levelData.goal.width, levelData.goal.height); }
      }

      // Souris
      canvas.addEventListener('mousedown', (e) => { isDrawing = true; handleClick(e); });
      canvas.addEventListener('mousemove', (e) => { if (isDrawing && currentTool === 'platform') handleClick(e); });
      canvas.addEventListener('mouseup', () => { isDrawing = false; });

      function handleClick(e) {
        const rect = canvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) / gridSize) * gridSize;
        const y = Math.floor((e.clientY - rect.top) / gridSize) * gridSize;
        if (currentTool === 'erase') {
          levelData.platforms = levelData.platforms.filter(p => !(p.x === x && p.y === y));
          levelData.spikes = levelData.spikes.filter(s => !(s.x === x && s.y === y));
          if (levelData.player && levelData.player.x === x && levelData.player.y === y) levelData.player = null;
          if (levelData.goal && levelData.goal.x === x && levelData.goal.y === y) levelData.goal = null;
        } else if (currentTool === 'platform') {
          if (!levelData.platforms.some(p => p.x === x && p.y === y)) levelData.platforms.push({ x, y, width: gridSize, height: gridSize });
        } else if (currentTool === 'player') {
          levelData.player = { x, y, width: gridSize, height: gridSize };
        } else if (currentTool === 'spike') {
          levelData.spikes.push({ x, y, width: gridSize, height: gridSize });
        } else if (currentTool === 'goal') {
          levelData.goal = { x, y, width: gridSize, height: gridSize };
        }
        redraw();
      }

      async function saveToGame() {
        const levelName = document.getElementById('levelName').value || 'niveau_1';
        if (!levelData.player) return showNotification('‚ö†Ô∏è Ajoutez une position de d√©part pour le joueur !', 'warn');
        if (!levelData.goal) return showNotification('‚ö†Ô∏è Ajoutez un point d\'arriv√©e !', 'warn');
        if (levelData.platforms.length === 0) return showNotification('‚ö†Ô∏è Ajoutez au moins une plateforme !', 'warn');

        try {
          if (!(window.storage && typeof window.storage.set === 'function')) {
            exportJSON();
            return showNotification('‚ÑπÔ∏è Pas de stockage int√©gr√©. JSON export√©, placez-le √† c√¥t√© du jeu.', 'warn');
          }
          const code = generatePythonCode(levelName);
          const id = `level_${Date.now()}`;
          await window.storage.set(id, JSON.stringify({ name: levelName, data: levelData, pythonCode: code, timestamp: Date.now() }));
          await window.storage.set('active_level', id);
          showNotification('‚úÖ Niveau sauvegard√© et activ√© dans le jeu !');
        } catch (e) {
          console.error(e);
          showNotification('‚ùå Erreur lors de la sauvegarde', 'error');
        }
      }

      function generatePythonCode(levelName) {
        let code = `# Niveau: ${levelName}\n`;
        code += `platforms = [\n`;
        levelData.platforms.forEach(p => { code += `    pygame.Rect(${p.x}, ${p.y}, ${p.width}, ${p.height}),\n`; });
        code += `]\n\n`;
        code += `spawn_point = pygame.Vector2(${levelData.player.x}, ${levelData.player.y})\n\n`;
        code += `goal_rect = pygame.Rect(${levelData.goal.x}, ${levelData.goal.y}, ${levelData.goal.width}, ${levelData.goal.height})\n\n`;
        if (levelData.spikes.length) {
          code += `spikes = [\n`;
          levelData.spikes.forEach(s => { code += `    pygame.Rect(${s.x}, ${s.y}, ${s.width}, ${s.height}),\n`; });
          code += `]\n`;
        }
        return code;
      }

      function exportJSON() {
        const data = { platforms: levelData.platforms, player: levelData.player, goal: levelData.goal, spikes: levelData.spikes };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        downloadBlob(blob, 'editor_level.json');
        showNotification('‚úÖ editor_level.json t√©l√©charg√©. Placez-le √† c√¥t√© du fichier Python du jeu.');
      }

      function exportPython() {
        const name = document.getElementById('levelName').value || 'niveau_1';
        const code = generatePythonCode(name);
        const blob = new Blob([code], { type: 'text/x-python' });
        downloadBlob(blob, 'editor_level.py');
        showNotification('‚úÖ editor_level.py t√©l√©charg√©. Placez-le √† c√¥t√© du fichier Python du jeu.');
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; document.body.appendChild(a); a.click();
        setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
      }

      function clearCanvas() {
        if (!confirm('Tout effacer ?')) return;
        levelData = { platforms: [], player: null, spikes: [], goal: null };
        document.getElementById('levelName').value = `niveau_${Date.now()}`;
        redraw();
      }

      function showNotification(message, type) {
        const n = document.createElement('div');
        n.className = 'notification';
        n.textContent = message;
        if (type === 'warn') n.style.background = '#ff9800';
        if (type === 'error') n.style.background = '#f44336';
        document.body.appendChild(n);
        setTimeout(() => n.remove(), 2500);
      }

      // Init
      redraw();
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âditeur de Niveaux - Isaac</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .toolbar {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 3px solid #667eea;
        }

        .tool-section {
            margin-bottom: 15px;
        }

        .tool-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .tool-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tool-btn {
            padding: 12px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tool-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .canvas-container {
            padding: 20px;
            background: #e9ecef;
            overflow: auto;
        }

        #gameCanvas {
            background: #87CEEB;
            border: 3px solid #333;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-top: 3px solid #667eea;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
        }

        .control-group input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .action-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .action-btn.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            box-shadow: 0 4px 12px rgba(56, 239, 125, 0.4);
            font-size: 18px;
            padding: 15px 30px;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border: 2px solid #333;
            border-radius: 4px;
        }

        .saved-levels {
            padding: 20px;
            background: #f8f9fa;
            border-top: 2px solid #ddd;
        }

        .saved-levels h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .level-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .level-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }

        .level-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .level-card.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .level-card h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .level-card p {
            font-size: 12px;
            color: #666;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ √âditeur de Niveaux</h1>
            <p>Cr√©ez vos propres niveaux pour le jeu de plateforme d'Isaac</p>
        </div>

        <div class="toolbar">
            <div class="tool-section">
                <h3>üõ†Ô∏è Outils de dessin</h3>
                <div class="tool-buttons">
                    <button class="tool-btn active" data-tool="platform">üü´ Plateforme</button>
                    <button class="tool-btn" data-tool="player">üë§ Joueur</button>
                    <button class="tool-btn" data-tool="enemy">üëæ Ennemi</button>
                    <button class="tool-btn" data-tool="coin">üí∞ Pi√®ce</button>
                    <button class="tool-btn" data-tool="spike">‚ö†Ô∏è Pi√®ge</button>
                    <button class="tool-btn" data-tool="goal">üéØ Arriv√©e</button>
                    <button class="tool-btn" data-tool="erase">üóëÔ∏è Effacer</button>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #8B4513;"></div>
                    <span>Plateforme</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4169E1;"></div>
                    <span>Joueur</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #DC143C;"></div>
                    <span>Ennemi</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFD700;"></div>
                    <span>Pi√®ce</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF4500;"></div>
                    <span>Pi√®ge</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #32CD32;"></div>
                    <span>Arriv√©e</span>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="gridSize">Taille grille:</label>
                <input type="number" id="gridSize" value="40" min="20" max="80">
            </div>
            
            <div class="control-group">
                <label for="levelName">Nom du niveau:</label>
                <input type="text" id="levelName" value="niveau_1" placeholder="mon_niveau">
            </div>

            <button class="action-btn success" onclick="saveToGame()">üöÄ Enregistrer dans le jeu</button>
            <button class="action-btn secondary" onclick="clearCanvas()">üóëÔ∏è Effacer tout</button>
        </div>

        <div class="saved-levels">
            <h3>üìö Niveaux sauvegard√©s</h3>
            <div class="level-list" id="levelList">
                <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">
                    Aucun niveau sauvegard√©. Cr√©ez votre premier niveau !
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let currentTool = 'platform';
        let gridSize = 40;
        let isDrawing = false;
        let currentLevelId = null;
        
        let levelData = {
            platforms: [],
            player: null,
            enemies: [],
            coins: [],
            spikes: [],
            goal: null
        };

        // Gestion des outils
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTool = this.dataset.tool;
            });
        });

        // Mise √† jour de la taille de grille
        document.getElementById('gridSize').addEventListener('change', function() {
            gridSize = parseInt(this.value);
            redraw();
        });

        // Dessin de la grille
        function drawGrid() {
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 0.5;
            
            for(let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for(let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // Redessiner tout
        function redraw() {
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawGrid();
            
            // Plateformes
            ctx.fillStyle = '#8B4513';
            levelData.platforms.forEach(p => {
                ctx.fillRect(p.x, p.y, p.width, p.height);
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(p.x, p.y, p.width, p.height);
            });
            
            // Joueur
            if(levelData.player) {
                ctx.fillStyle = '#4169E1';
                ctx.fillRect(levelData.player.x, levelData.player.y, levelData.player.width, levelData.player.height);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.strokeRect(levelData.player.x, levelData.player.y, levelData.player.width, levelData.player.height);
            }
            
            // Ennemis
            ctx.fillStyle = '#DC143C';
            levelData.enemies.forEach(e => {
                ctx.fillRect(e.x, e.y, e.width, e.height);
                ctx.strokeStyle = '#8B0000';
                ctx.lineWidth = 2;
                ctx.strokeRect(e.x, e.y, e.width, e.height);
            });
            
            // Pi√®ces
            ctx.fillStyle = '#FFD700';
            levelData.coins.forEach(c => {
                ctx.beginPath();
                ctx.arc(c.x + c.width/2, c.y + c.height/2, c.width/2, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#DAA520';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
            
            // Pi√®ges
            ctx.fillStyle = '#FF4500';
            levelData.spikes.forEach(s => {
                ctx.fillRect(s.x, s.y, s.width, s.height);
                ctx.strokeStyle = '#8B0000';
                ctx.lineWidth = 2;
                ctx.strokeRect(s.x, s.y, s.width, s.height);
            });
            
            // Arriv√©e
            if(levelData.goal) {
                ctx.fillStyle = '#32CD32';
                ctx.fillRect(levelData.goal.x, levelData.goal.y, levelData.goal.width, levelData.goal.height);
                ctx.strokeStyle = '#228B22';
                ctx.lineWidth = 2;
                ctx.strokeRect(levelData.goal.x, levelData.goal.y, levelData.goal.width, levelData.goal.height);
            }
        }

        // Gestion de la souris
        canvas.addEventListener('mousedown', function(e) {
            isDrawing = true;
            handleClick(e);
        });

        canvas.addEventListener('mousemove', function(e) {
            if(isDrawing && currentTool === 'platform') {
                handleClick(e);
            }
        });

        canvas.addEventListener('mouseup', function() {
            isDrawing = false;
        });

        function handleClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / gridSize) * gridSize;
            const y = Math.floor((e.clientY - rect.top) / gridSize) * gridSize;
            
            if(currentTool === 'erase') {
                levelData.platforms = levelData.platforms.filter(p => !(p.x === x && p.y === y));
                levelData.enemies = levelData.enemies.filter(e => !(e.x === x && e.y === y));
                levelData.coins = levelData.coins.filter(c => !(c.x === x && c.y === y));
                levelData.spikes = levelData.spikes.filter(s => !(s.x === x && s.y === y));
                if(levelData.player && levelData.player.x === x && levelData.player.y === y) levelData.player = null;
                if(levelData.goal && levelData.goal.x === x && levelData.goal.y === y) levelData.goal = null;
            }
            else if(currentTool === 'platform') {
                const exists = levelData.platforms.some(p => p.x === x && p.y === y);
                if(!exists) {
                    levelData.platforms.push({x, y, width: gridSize, height: gridSize});
                }
            }
            else if(currentTool === 'player') {
                levelData.player = {x, y, width: gridSize, height: gridSize};
            }
            else if(currentTool === 'enemy') {
                levelData.enemies.push({x, y, width: gridSize, height: gridSize});
            }
            else if(currentTool === 'coin') {
                levelData.coins.push({x, y, width: gridSize, height: gridSize});
            }
            else if(currentTool === 'spike') {
                levelData.spikes.push({x, y, width: gridSize, height: gridSize});
            }
            else if(currentTool === 'goal') {
                levelData.goal = {x, y, width: gridSize, height: gridSize};
            }
            
            redraw();
        }

        async function saveToGame() {
            const levelName = document.getElementById('levelName').value || 'niveau_1';
            
            if(!levelData.player) {
                showNotification('‚ö†Ô∏è Ajoutez une position de d√©part pour le joueur !', 'warning');
                return;
            }

            if(!levelData.goal) {
                showNotification('‚ö†Ô∏è Ajoutez un point d\'arriv√©e !', 'warning');
                return;
            }

            if(levelData.platforms.length === 0) {
                showNotification('‚ö†Ô∏è Ajoutez au moins une plateforme !', 'warning');
                return;
            }

            try {
                // Convertir les donn√©es en format Python pour le jeu
                const pythonCode = generatePythonCode(levelName);
                
                // Sauvegarder le niveau
                const levelId = currentLevelId || `level_${Date.now()}`;
                await window.storage.set(levelId, JSON.stringify({
                    name: levelName,
                    data: levelData,
                    pythonCode: pythonCode,
                    timestamp: Date.now()
                }));

                // Sauvegarder aussi le niveau actif
                await window.storage.set('active_level', levelId);

                currentLevelId = levelId;
                
                showNotification('‚úÖ Niveau sauvegard√© et activ√© dans le jeu !', 'success');
                loadLevelList();
            } catch(error) {
                console.error('Erreur:', error);
                showNotification('‚ùå Erreur lors de la sauvegarde', 'error');
            }
        }

        function generatePythonCode(levelName) {
            let code = `# Niveau: ${levelName}\n`;
            code += `# Plateformes\n`;
            code += `platforms = [\n`;
            levelData.platforms.forEach(p => {
                code += `    pygame.Rect(${p.x}, ${p.y}, ${p.width}, ${p.height}),\n`;
            });
            code += `]\n\n`;
            
            code += `# Position du joueur\n`;
            code += `spawn_point = pygame.Vector2(${levelData.player.x}, ${levelData.player.y})\n\n`;
            
            code += `# Porte d'arriv√©e\n`;
            code += `goal_rect = pygame.Rect(${levelData.goal.x}, ${levelData.goal.y}, ${levelData.goal.width}, ${levelData.goal.height})\n\n`;
            
            if(levelData.spikes.length > 0) {
                code += `# Pi√®ges\n`;
                code += `spikes = [\n`;
                levelData.spikes.forEach(s => {
                    code += `    pygame.Rect(${s.x}, ${s.y}, ${s.width}, ${s.height}),\n`;
                });
                code += `]\n`;
            }
            
            return code;
        }

        async function loadLevelList() {
            try {
                const result = await window.storage.list('level_');
                const levelListDiv = document.getElementById('levelList');
                
                if(!result || !result.keys || result.keys.length === 0) {
                    levelListDiv.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">Aucun niveau sauvegard√©. Cr√©ez votre premier niveau !</div>';
                    return;
                }

                levelListDiv.innerHTML = '';
                
                for(const key of result.keys) {
                    try {
                        const levelResult = await window.storage.get(key);
                        if(levelResult) {
                            const level = JSON.parse(levelResult.value);
                            const card = document.createElement('div');
                            card.className = 'level-card';
                            if(key === currentLevelId) card.classList.add('active');
                            
                            const date = new Date(level.timestamp);
                            card.innerHTML = `
                                <h4>${level.name}</h4>
                                <p>üì¶ ${level.data.platforms.length} plateformes</p>
                                <p>üëæ ${level.data.enemies.length} ennemis</p>
                                <p>üí∞ ${level.data.coins.length} pi√®ces</p>
                                <p style="margin-top: 5px; font-size: 11px;">üìÖ ${date.toLocaleDateString('fr-FR')}</p>
                            `;
                            
                            card.onclick = () => loadLevel(key);
                            levelListDiv.appendChild(card);
                        }
                    } catch(e) {
                        console.error('Erreur chargement niveau:', e);
                    }
                }
            } catch(error) {
                console.error('Erreur liste:', error);
            }
        }

        async function loadLevel(levelId) {
            try {
                const result = await window.storage.get(levelId);
                if(result) {
                    const level = JSON.parse(result.value);
                    levelData = level.data;
                    currentLevelId = levelId;
                    document.getElementById('levelName').value = level.name;
                    redraw();
                    loadLevelList();
                    showNotification('‚úÖ Niveau charg√© !', 'success');
                }
            } catch(error) {
                console.error('Erreur:', error);
                showNotification('‚ùå Erreur lors du chargement', 'error');
            }
        }

        function clearCanvas() {
            if(confirm('√ätes-vous s√ªr de vouloir tout effacer ?')) {
                levelData = {
                    platforms: [],
                    player: null,
                    enemies: [],
                    coins: [],
                    spikes: [],
                    goal: null
                };
                currentLevelId = null;
                document.getElementById('levelName').value = `niveau_${Date.now()}`;
                redraw();
                loadLevelList();
            }
        }

        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            
            if(type === 'warning') notif.style.background = '#ff9800';
            if(type === 'error') notif.style.background = '#f44336';
            
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.remove();
            }, 3000);
        }

        // Initialisation
        redraw();
        loadLevelList();
    </script>
</body>
</html>
