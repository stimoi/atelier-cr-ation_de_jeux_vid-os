<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ã‰diteur de niveaux</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; display: grid; grid-template-columns: 360px 1fr; height: 100vh; }
    header { grid-column: 1 / -1; padding: 10px 16px; background: #222; color: #fff; display: flex; align-items: center; gap: 8px; }
    header h1 { font-size: 18px; margin: 0; }
    .sidebar { overflow: auto; border-right: 1px solid #ddd; padding: 12px; display: flex; flex-direction: column; gap: 16px; }
    .section { border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
    .section h2 { margin: 0 0 8px 0; font-size: 16px; }
    label { display: block; font-size: 12px; color: #333; margin-top: 8px; }
    input[type="number"], input[type="text"] { width: 100%; box-sizing: border-box; padding: 6px 8px; margin-top: 4px; }
    button { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
    button.primary { background: #2563eb; color: white; border-color: #2563eb; }
    button.danger { background: #dc2626; color: white; border-color: #dc2626; }
    .row { display: flex; gap: 8px; align-items: center; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .platforms { display: flex; flex-direction: column; gap: 8px; max-height: 240px; overflow: auto; }
    .platform { display: grid; grid-template-columns: repeat(4, 1fr) 32px; gap: 6px; }
    .canvas-wrap { position: relative; height: calc(100vh - 60px); background: #eef6ff; }
    canvas { width: 100%; height: 100%; display: block; background: linear-gradient(#7db3e8, #cfe9ff); }
    .toolbar { position: absolute; top: 12px; left: 12px; display: flex; gap: 8px; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 8px; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color: #555; }
  </style>
</head>
<body>
  <header>
    <h1>Ã‰diteur de niveaux</h1>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <input type="file" id="importFile" accept="application/json" />
      <button class="primary" id="exportBtn">Exporter levels.json</button>
    </div>
  </header>

  <div class="sidebar">
    <div class="section">
      <h2>Niveaux</h2>
      <div class="row">
        <select id="levelSelect" style="flex:1"></select>
        <button id="addLevelBtn">Ajouter</button>
        <button class="danger" id="deleteLevelBtn">Suppr</button>
      </div>
      <label>Nom</label>
      <input type="text" id="levelName" placeholder="Nom du niveau" />
    </div>

    <div class="section">
      <h2>Sol</h2>
      <div class="grid-2">
        <div>
          <label>Y</label>
          <input type="number" id="groundY" />
        </div>
        <div>
          <label>DÃ©but X</label>
          <input type="number" id="groundStart" />
        </div>
        <div>
          <label>Fin X</label>
          <input type="number" id="groundEnd" />
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Spawn</h2>
      <div class="grid-2">
        <div>
          <label>X</label>
          <input type="number" id="spawnX" />
        </div>
        <div>
          <label>Y</label>
          <input type="number" id="spawnY" />
        </div>
      </div>
    </div>

    <div class="section">
      <h2>But (porte)</h2>
      <div class="grid-2">
        <div>
          <label>X</label>
          <input type="number" id="goalX" />
        </div>
        <div>
          <label>Y</label>
          <input type="number" id="goalY" />
        </div>
        <div>
          <label>Largeur</label>
          <input type="number" id="goalW" />
        </div>
        <div>
          <label>Hauteur</label>
          <input type="number" id="goalH" />
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Plateformes</h2>
      <div class="platforms" id="platformList"></div>
      <button id="addPlatformBtn">+ Ajouter une plateforme</button>
      <small class="mono">Astuce: cliquez dans la prÃ©visualisation pour ajouter rapidement (100x20).</small>
    </div>
  </div>

  <div class="canvas-wrap">
    <div class="toolbar">
      <small class="mono">AperÃ§u. DÃ©filement horizontal: molette Shift.</small>
      <small class="mono">Zoom: Ctrl + molette.</small>
    </div>
    <canvas id="view"></canvas>
  </div>

  <script>
    const DEFAULT_LEVEL = {
      name: 'Niveau 1',
      ground: { y: 680, start_x: 0, end_x: 3000 },
      spawn: { x: 683, y: 590 },
      goal: { x: 2300, y: -30, w: 70, h: 110 },
      platforms: [
        { x: 100, y: 560, w: 200, h: 20 },
        { x: 380, y: 480, w: 180, h: 20 },
        { x: 620, y: 420, w: 160, h: 20 },
        { x: 860, y: 360, w: 140, h: 20 },
        { x: 1060, y: 300, w: 180, h: 20 },
        { x: 1300, y: 200, w: 250, h: 20 },
        { x: 1600, y: 600, w: 100, h: 20 },
        { x: 1750, y: 500, w: 100, h: 20 },
        { x: 1600, y: 400, w: 100, h: 20 },
        { x: 1750, y: 300, w: 100, h: 20 },
        { x: 1600, y: 200, w: 100, h: 20 },
        { x: 1750, y: 100, w: 100, h: 20 },
        { x: 1900, y: 60,  w: 500, h: 20 }
      ]
    };

    let data = { levels: [ structuredClone(DEFAULT_LEVEL) ] };
    let current = 0;

    const els = {
      levelSelect: document.getElementById('levelSelect'),
      levelName: document.getElementById('levelName'),
      groundY: document.getElementById('groundY'),
      groundStart: document.getElementById('groundStart'),
      groundEnd: document.getElementById('groundEnd'),
      spawnX: document.getElementById('spawnX'),
      spawnY: document.getElementById('spawnY'),
      goalX: document.getElementById('goalX'),
      goalY: document.getElementById('goalY'),
      goalW: document.getElementById('goalW'),
      goalH: document.getElementById('goalH'),
      platformList: document.getElementById('platformList'),
      addPlatformBtn: document.getElementById('addPlatformBtn'),
      addLevelBtn: document.getElementById('addLevelBtn'),
      deleteLevelBtn: document.getElementById('deleteLevelBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importFile: document.getElementById('importFile'),
      view: document.getElementById('view')
    };

    function refreshLevelSelect() {
      els.levelSelect.innerHTML = '';
      data.levels.forEach((lvl, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${i+1}. ${lvl.name || 'Sans nom'}`;
        els.levelSelect.appendChild(opt);
      });
      els.levelSelect.value = String(current);
    }

    function bindValue(input, getter, setter) {
      input.value = getter();
      input.oninput = () => { setter(Number.isFinite(+input.value) ? +input.value : input.value); draw(); };
    }

    function renderForm() {
      const lvl = data.levels[current];
      els.levelName.value = lvl.name || '';
      bindValue(els.groundY, () => lvl.ground.y, v => lvl.ground.y = v);
      bindValue(els.groundStart, () => lvl.ground.start_x, v => lvl.ground.start_x = v);
      bindValue(els.groundEnd, () => lvl.ground.end_x, v => lvl.ground.end_x = v);
      bindValue(els.spawnX, () => lvl.spawn.x, v => lvl.spawn.x = v);
      bindValue(els.spawnY, () => lvl.spawn.y, v => lvl.spawn.y = v);
      bindValue(els.goalX, () => lvl.goal.x, v => lvl.goal.x = v);
      bindValue(els.goalY, () => lvl.goal.y, v => lvl.goal.y = v);
      bindValue(els.goalW, () => lvl.goal.w, v => lvl.goal.w = v);
      bindValue(els.goalH, () => lvl.goal.h, v => lvl.goal.h = v);

      els.levelName.oninput = () => { lvl.name = els.levelName.value; refreshLevelSelect(); };

      els.platformList.innerHTML = '';
      lvl.platforms.forEach((p, idx) => {
        const row = document.createElement('div');
        row.className = 'platform';
        row.innerHTML = `
          <input type="number" value="${p.x}" />
          <input type="number" value="${p.y}" />
          <input type="number" value="${p.w}" />
          <input type="number" value="${p.h}" />
          <button data-idx="${idx}">Ã—</button>
        `;
        const [x,y,w,h,btn] = row.querySelectorAll('input,button');
        x.oninput = () => { p.x = +x.value; draw(); };
        y.oninput = () => { p.y = +y.value; draw(); };
        w.oninput = () => { p.w = +w.value; draw(); };
        h.oninput = () => { p.h = +h.value; draw(); };
        btn.onclick = () => { lvl.platforms.splice(idx,1); renderForm(); draw(); };
        els.platformList.appendChild(row);
      });
    }

    els.addPlatformBtn.onclick = () => {
      data.levels[current].platforms.push({ x: 100, y: 100, w: 100, h: 20 });
      renderForm();
      draw();
    };

    els.addLevelBtn.onclick = () => {
      data.levels.push(structuredClone(DEFAULT_LEVEL));
      current = data.levels.length - 1;
      refreshLevelSelect();
      renderForm();
      draw();
    };

    els.deleteLevelBtn.onclick = () => {
      if (data.levels.length <= 1) return;
      data.levels.splice(current, 1);
      current = Math.max(0, current - 1);
      refreshLevelSelect();
      renderForm();
      draw();
    };

    els.levelSelect.onchange = () => {
      current = +els.levelSelect.value;
      renderForm();
      draw();
    };

    els.exportBtn.onclick = () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'levels.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    els.importFile.onchange = async () => {
      const file = els.importFile.files?.[0];
      if (!file) return;
      const text = await file.text();
      try {
        const json = JSON.parse(text);
        if (!json.levels || !Array.isArray(json.levels)) throw new Error('levels[] manquant');
        data = json;
        current = 0;
        refreshLevelSelect();
        renderForm();
        draw();
      } catch (e) {
        alert('Fichier invalide: ' + e.message);
      } finally {
        els.importFile.value = '';
      }
    };

    // Canvas preview
    const ctx = els.view.getContext('2d');
    let zoom = 1;
    let scrollX = 0, scrollY = 0;

    function resize() {
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      els.view.width = Math.floor(els.view.clientWidth * dpr);
      els.view.height = Math.floor(els.view.clientHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      draw();
    }
    window.addEventListener('resize', resize);

    els.view.addEventListener('wheel', (e) => {
      if (e.ctrlKey) {
        e.preventDefault();
        const delta = Math.sign(e.deltaY);
        zoom = Math.min(3, Math.max(0.25, zoom * (delta > 0 ? 0.9 : 1.1)));
        draw();
      } else if (e.shiftKey) {
        e.preventDefault();
        scrollX += e.deltaY;
        draw();
      }
    }, { passive: false });

    els.view.addEventListener('click', (e) => {
      const rect = els.view.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (els.view.width / rect.width);
      const y = (e.clientY - rect.top) * (els.view.height / rect.height);
      const px = (x - scrollX) / zoom;
      const py = (y - scrollY) / zoom;
      const lvl = data.levels[current];
      lvl.platforms.push({ x: Math.round(px), y: Math.round(py), w: 100, h: 20 });
      renderForm();
      draw();
    });

    function drawGrid() {
      const w = els.view.clientWidth, h = els.view.clientHeight;
      ctx.save();
      ctx.translate(scrollX, scrollY);
      ctx.scale(zoom, zoom);
      ctx.clearRect(-scrollX/zoom, -scrollY/zoom, w/zoom, h/zoom);
      ctx.fillStyle = '#a9d3ff';
      ctx.fillRect(-scrollX/zoom, -scrollY/zoom, w/zoom, h/zoom);
      const step = 50;
      ctx.strokeStyle = '#cde5ff';
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let x = -scrollX/zoom % step; x < w/zoom; x += step) {
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h/zoom);
      }
      for (let y = -scrollY/zoom % step; y < h/zoom; y += step) {
        ctx.moveTo(0, y);
        ctx.lineTo(w/zoom, y);
      }
      ctx.stroke();
      ctx.restore();
    }

    function draw() {
      const w = els.view.clientWidth, h = els.view.clientHeight;
      ctx.clearRect(0, 0, w, h);
      drawGrid();
      const lvl = data.levels[current];
      ctx.save();
      ctx.translate(scrollX, scrollY);
      ctx.scale(zoom, zoom);

      // Ground
      ctx.fillStyle = '#2e8b57';
      ctx.fillRect(lvl.ground.start_x, lvl.ground.y, lvl.ground.end_x - lvl.ground.start_x, 100);

      // Platforms
      ctx.fillStyle = '#654321';
      ctx.strokeStyle = '#8b5a2b';
      lvl.platforms.forEach(p => {
        ctx.fillRect(p.x, p.y, p.w, p.h);
        ctx.strokeRect(p.x, p.y, p.w, p.h);
      });

      // Goal
      ctx.fillStyle = '#b8860b';
      ctx.fillRect(lvl.goal.x, lvl.goal.y, lvl.goal.w, lvl.goal.h);

      // Spawn
      ctx.fillStyle = '#1f6feb';
      ctx.beginPath();
      ctx.arc(lvl.spawn.x, lvl.spawn.y, 10, 0, Math.PI * 2);
      ctx.fill();

      ctx.restore();
    }

    // Init
    refreshLevelSelect();
    renderForm();
    resize();
    draw();
  </script>
</body>
</html>
